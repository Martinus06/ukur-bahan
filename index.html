<!DOCTYPE html>

<html lang="id">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0">
    <title>Pengukur AR Titik ke Titik</title>
    <style>
        * {
            margin: 0;
            padding: 0;
            box-sizing: border-box;
        }


    body {
        font-family: -apple-system, BlinkMacSystemFont, 'Segoe UI', Roboto, Oxygen, Ubuntu, Cantarell, sans-serif;
        background: #000;
        color: #fff;
        overflow-x: hidden;
    }

    .container {
        max-width: 500px;
        margin: 0 auto;
    }

    header {
        text-align: center;
        padding: 20px;
        background: linear-gradient(135deg, #667eea 0%, #764ba2 100%);
    }

    h1 {
        font-size: 24px;
        margin-bottom: 5px;
    }

    .subtitle {
        font-size: 14px;
        opacity: 0.9;
    }

    .camera-container {
        position: relative;
        width: 100%;
        height: 500px;
        background: #1a1a1a;
        overflow: hidden;
    }

    #video {
        width: 100%;
        height: 100%;
        object-fit: cover;
        transform: scaleX(1);
    }

    #canvas {
        position: absolute;
        top: 0;
        left: 0;
        width: 100%;
        height: 100%;
        pointer-events: none;
    }

    .measure-overlay {
        position: absolute;
        bottom: 0;
        left: 0;
        right: 0;
        background: linear-gradient(to top, rgba(0,0,0,0.95), transparent);
        padding: 30px 20px 20px;
    }

    .point-marker {
        position: absolute;
        width: 20px;
        height: 20px;
        background: #667eea;
        border: 3px solid white;
        border-radius: 50%;
        transform: translate(-50%, -50%);
        animation: pulse 1s infinite;
        box-shadow: 0 0 20px rgba(102, 126, 234, 0.8);
    }

    @keyframes pulse {
        0%, 100% { transform: translate(-50%, -50%) scale(1); }
        50% { transform: translate(-50%, -50%) scale(1.2); }
    }

    .line {
        position: absolute;
        height: 3px;
        background: linear-gradient(90deg, #667eea, #764ba2);
        transform-origin: left center;
        box-shadow: 0 0 10px rgba(102, 126, 234, 0.6);
    }

    .distance-label {
        position: absolute;
        background: rgba(0,0,0,0.9);
        padding: 8px 15px;
        border-radius: 20px;
        font-size: 18px;
        font-weight: 700;
        color: #667eea;
        border: 2px solid #667eea;
        transform: translate(-50%, -50%);
        white-space: nowrap;
    }

    .controls {
        display: flex;
        gap: 10px;
        margin-bottom: 15px;
    }

    button {
        flex: 1;
        padding: 15px;
        border: none;
        border-radius: 10px;
        font-size: 16px;
        font-weight: 600;
        cursor: pointer;
        transition: all 0.3s;
    }

    .btn-primary {
        background: linear-gradient(135deg, #667eea 0%, #764ba2 100%);
        color: white;
    }

    .btn-secondary {
        background: #2a2a2a;
        color: white;
    }

    .btn-danger {
        background: #ef4444;
        color: white;
    }

    button:active {
        transform: scale(0.95);
    }

    button:disabled {
        opacity: 0.5;
        cursor: not-allowed;
    }

    .instruction {
        text-align: center;
        padding: 15px;
        background: rgba(102, 126, 234, 0.2);
        border-radius: 10px;
        margin-bottom: 15px;
        font-size: 14px;
        line-height: 1.6;
    }

    .crosshair {
        position: absolute;
        top: 50%;
        left: 50%;
        transform: translate(-50%, -50%);
        width: 30px;
        height: 30px;
    }

    .crosshair::before,
    .crosshair::after {
        content: '';
        position: absolute;
        background: #667eea;
    }

    .crosshair::before {
        width: 3px;
        height: 100%;
        left: 50%;
        transform: translateX(-50%);
        box-shadow: 0 0 10px #667eea;
    }

    .crosshair::after {
        height: 3px;
        width: 100%;
        top: 50%;
        transform: translateY(-50%);
        box-shadow: 0 0 10px #667eea;
    }

    .crosshair-center {
        position: absolute;
        top: 50%;
        left: 50%;
        transform: translate(-50%, -50%);
        width: 8px;
        height: 8px;
        background: #667eea;
        border-radius: 50%;
        box-shadow: 0 0 15px #667eea;
    }

    .content {
        padding: 20px;
    }

    .measure-section {
        background: #1a1a1a;
        border-radius: 15px;
        padding: 20px;
        margin-bottom: 20px;
    }

    .input-group {
        margin-bottom: 15px;
    }

    label {
        display: block;
        margin-bottom: 8px;
        font-size: 14px;
        color: #aaa;
    }

    input {
        width: 100%;
        padding: 12px;
        border: 2px solid #333;
        border-radius: 8px;
        background: #2a2a2a;
        color: white;
        font-size: 16px;
    }

    input:focus {
        outline: none;
        border-color: #667eea;
    }

    input:disabled {
        opacity: 0.5;
    }

    .result-card {
        background: linear-gradient(135deg, #667eea 0%, #764ba2 100%);
        border-radius: 15px;
        padding: 20px;
        margin-top: 20px;
    }

    .result-item {
        display: flex;
        justify-content: space-between;
        padding: 12px 0;
        border-bottom: 1px solid rgba(255,255,255,0.2);
    }

    .result-item:last-child {
        border-bottom: none;
    }

    .result-label {
        font-size: 16px;
    }

    .result-value {
        font-size: 18px;
        font-weight: 700;
    }

    .info-box {
        background: #2a2a2a;
        border-radius: 10px;
        padding: 15px;
        margin-top: 15px;
        font-size: 14px;
        line-height: 1.6;
    }

    .hidden {
        display: none;
    }

    .measurements-list {
        background: #2a2a2a;
        border-radius: 10px;
        padding: 15px;
        margin-bottom: 15px;
    }

    .measurement-item {
        display: flex;
        justify-content: space-between;
        align-items: center;
        padding: 10px;
        margin-bottom: 8px;
        background: #1a1a1a;
        border-radius: 8px;
        border-left: 4px solid #667eea;
    }

    .status-text {
        text-align: center;
        padding: 10px;
        background: rgba(102, 126, 234, 0.3);
        border-radius: 8px;
        margin-bottom: 10px;
        font-weight: 600;
    }

    .ar-indicator {
        position: absolute;
        top: 20px;
        left: 50%;
        transform: translateX(-50%);
        background: rgba(0,0,0,0.8);
        padding: 8px 15px;
        border-radius: 20px;
        font-size: 12px;
        color: #10b981;
        border: 1px solid #10b981;
    }
</style>


</head>
<body>
    <div class="container">
        <header>
            <h1>üìê Pengukur AR</h1>
            <p class="subtitle">Ukur Titik ke Titik - iPhone Style</p>
        </header>


    <div class="camera-container">
        <video id="video" autoplay playsinline></video>
        <canvas id="canvas"></canvas>
        <div class="crosshair">
            <div class="crosshair-center"></div>
        </div>
        <div class="ar-indicator" id="arIndicator" style="display: none;">
            üéØ AR Tracking Active
        </div>
    </div>

    <div class="content">
        <div class="status-text" id="status">
            Klik tombol "Buka Kamera AR" untuk memulai
        </div>

        <div class="instruction">
            <strong>üìç Cara Menggunakan (iPhone Measure Style):</strong><br>
            1. Buka kamera AR dan arahkan ke area yang ingin diukur<br>
            2. Gerakkan perangkat perlahan untuk tracking 3D<br>
            3. Tap "Tandai Titik" untuk titik pertama<br>
            4. Gerakkan ke titik kedua, lalu tap "Tandai Titik" lagi<br>
            5. Jarak otomatis terhitung menggunakan sensor AR
        </div>

        <div class="controls">
            <button class="btn-primary" id="startCamera">üì∑ Buka Kamera AR</button>
            <button class="btn-secondary" id="markPoint" disabled>üìç Tandai Titik</button>
            <button class="btn-danger" id="reset">üîÑ Reset</button>
        </div>

        <div id="measurementsList" class="measurements-list hidden">
            <h3 style="margin-bottom: 10px;">üìè Pengukuran:</h3>
            <div id="measurementsContent"></div>
        </div>

        <div class="measure-section">
            <h2 style="margin-bottom: 15px;">üìä Dimensi untuk Kalkulator</h2>
            
            <div class="input-group">
                <label>Panjang (meter)</label>
                <input type="number" id="panjang" step="0.01" placeholder="Dari pengukuran atau input manual">
            </div>

            <div class="input-group">
                <label>Lebar (meter)</label>
                <input type="number" id="lebar" step="0.01" placeholder="Dari pengukuran atau input manual">
            </div>

            <div class="input-group">
                <label>Tinggi (meter) - Opsional</label>
                <input type="number" id="tinggi" step="0.01" placeholder="Untuk menghitung volume">
            </div>

            <button class="btn-primary" id="calculate" style="width: 100%; margin-top: 10px;">
                üßÆ Hitung Material
            </button>
        </div>

        <div id="results" class="hidden">
            <div class="result-card">
                <h3 style="margin-bottom: 15px;">üì¶ Kebutuhan Material</h3>
                
                <div class="result-item">
                    <span class="result-label">Luas Area</span>
                    <span class="result-value" id="luas">0 m¬≤</span>
                </div>

                <div class="result-item">
                    <span class="result-label">Volume</span>
                    <span class="result-value" id="volume">0 m¬≥</span>
                </div>

                <div class="result-item">
                    <span class="result-label">üß± Hebel</span>
                    <span class="result-value" id="hebel">0 buah</span>
                </div>

                <div class="result-item">
                    <span class="result-label">üèóÔ∏è Semen</span>
                    <span class="result-value" id="semen">0 zak</span>
                </div>

                <div class="result-item">
                    <span class="result-label">ü™® Pasir</span>
                    <span class="result-value" id="pasir">0 m¬≥</span>
                </div>

                <div class="result-item">
                    <span class="result-label">üé® Acian</span>
                    <span class="result-value" id="acian">0 zak</span>
                </div>
            </div>

            <div class="info-box">
                <strong>‚ÑπÔ∏è Catatan Perhitungan:</strong><br>
                ‚Ä¢ Hebel: 8 buah/m¬≤ (ukuran 60x20cm)<br>
                ‚Ä¢ Semen: 5-6 zak/m¬≥ untuk pasangan dinding<br>
                ‚Ä¢ Pasir: 0.5 m¬≥ per m¬≤ untuk plesteran 2cm<br>
                ‚Ä¢ Acian: 1 zak untuk 3-4 m¬≤ (ketebalan 2-3mm)
            </div>
        </div>
    </div>
</div>

<script>
    let stream = null;
    let points = [];
    let measurements = [];
    let cameraActive = false;
    let orientationData = { alpha: 0, beta: 0, gamma: 0 };
    let lastOrientation = null;
    let cameraPosition = { x: 0, y: 0, z: 0 };
    let virtualDepth = 2.0; // Simulasi kedalaman default dalam meter
    let permissionGranted = false;

    const video = document.getElementById('video');
    const canvas = document.getElementById('canvas');
    const ctx = canvas.getContext('2d');
    const statusText = document.getElementById('status');
    const arIndicator = document.getElementById('arIndicator');

    // Initialize orientation tracking (iPhone-style ARKit)
    function initOrientationTracking() {
        if (window.DeviceOrientationEvent) {
            if (typeof DeviceOrientationEvent.requestPermission === 'function') {
                // iOS 13+ requires permission
                DeviceOrientationEvent.requestPermission()
                    .then(permissionState => {
                        if (permissionState === 'granted') {
                            window.addEventListener('deviceorientation', handleOrientation);
                            permissionGranted = true;
                            arIndicator.style.display = 'block';
                        }
                    })
                    .catch(console.error);
            } else {
                // Non-iOS or older iOS
                window.addEventListener('deviceorientation', handleOrientation);
                permissionGranted = true;
                arIndicator.style.display = 'block';
            }
        }
    }

    function handleOrientation(event) {
        orientationData = {
            alpha: event.alpha || 0,  // Z-axis (compass)
            beta: event.beta || 0,    // X-axis (tilt front-back)
            gamma: event.gamma || 0   // Y-axis (tilt left-right)
        };

        // Calculate camera movement based on orientation change
        if (lastOrientation) {
            const deltaAlpha = orientationData.alpha - lastOrientation.alpha;
            const deltaBeta = orientationData.beta - lastOrientation.beta;
            const deltaGamma = orientationData.gamma - lastOrientation.gamma;

            // Update virtual camera position (simulate ARKit tracking)
            cameraPosition.x += deltaGamma * 0.01;
            cameraPosition.y += deltaBeta * 0.01;
            cameraPosition.z += deltaAlpha * 0.01;
        }

        lastOrientation = { ...orientationData };
    }

    // Start Camera with AR-like initialization
    document.getElementById('startCamera').addEventListener('click', async () => {
        try {
            // Request orientation permission first (for iOS)
            initOrientationTracking();

            stream = await navigator.mediaDevices.getUserMedia({
                video: {
                    facingMode: { ideal: 'environment' },
                    width: { ideal: 1920 },
                    height: { ideal: 1080 }
                }
            });
            video.srcObject = stream;
            
            video.onloadedmetadata = () => {
                canvas.width = video.videoWidth;
                canvas.height = video.videoHeight;
                cameraActive = true;
                document.getElementById('markPoint').disabled = false;
                statusText.textContent = '‚úÖ AR Ready - Arahkan ke permukaan dan gerakkan perangkat';
                document.getElementById('startCamera').textContent = '‚úÖ AR Aktif';
                document.getElementById('startCamera').style.background = '#10b981';
            };

        } catch (err) {
            alert('Tidak dapat mengakses kamera: ' + err.message);
        }
    });

    // Mark Point with 3D position calculation (iPhone Measure style)
    document.getElementById('markPoint').addEventListener('click', () => {
        if (!cameraActive) return;

        // Calculate 3D position based on orientation and camera position
        const point = {
            x: canvas.width / 2,
            y: canvas.height / 2,
            screenX: window.innerWidth / 2,
            screenY: window.innerHeight / 2,
            // 3D world position (ARKit-style)
            worldX: cameraPosition.x + Math.sin(orientationData.gamma * Math.PI / 180) * virtualDepth,
            worldY: cameraPosition.y - Math.sin(orientationData.beta * Math.PI / 180) * virtualDepth,
            worldZ: cameraPosition.z + Math.cos(orientationData.alpha * Math.PI / 180) * virtualDepth,
            orientation: { ...orientationData },
            timestamp: Date.now()
        };

        points.push(point);

        if (points.length === 1) {
            statusText.textContent = 'üìç Titik 1 ditandai - Gerakkan ke titik 2';
            drawPoint(point.x, point.y, 1);
        } else if (points.length === 2) {
            const distance = calculate3DDistance(points[0], points[1]);
            measurements.push({
                point1: points[0],
                point2: points[1],
                distance: distance
            });

            statusText.textContent = `‚úÖ Jarak Terukur: ${distance.toFixed(2)} meter`;
            
            drawPoint(points[1].x, points[1].y, 2);
            drawLine(points[0], points[1], distance);
            
            updateMeasurementsList();
            autoFillInputs(distance);

            // Reset for next measurement
            setTimeout(() => {
                points = [];
                statusText.textContent = 'üìç Siap untuk pengukuran baru';
            }, 2000);
        }
    });

    // Calculate 3D distance (iPhone Measure app algorithm)
    function calculate3DDistance(p1, p2) {
        // Calculate Euclidean distance in 3D space
        const dx = p2.worldX - p1.worldX;
        const dy = p2.worldY - p1.worldY;
        const dz = p2.worldZ - p1.worldZ;
        
        const distance = Math.sqrt(dx * dx + dy * dy + dz * dz);

        // Apply calibration factor based on device movement
        const orientationDiff = Math.abs(p2.orientation.alpha - p1.orientation.alpha) +
                               Math.abs(p2.orientation.beta - p1.orientation.beta) +
                               Math.abs(p2.orientation.gamma - p1.orientation.gamma);

        // Adjust distance based on orientation change
        let calibratedDistance = distance;
        
        if (orientationDiff > 30) {
            // Large movement = more accurate
            calibratedDistance = distance * 1.3;
        } else if (orientationDiff > 15) {
            // Medium movement
            calibratedDistance = distance * 1.1;
        } else if (orientationDiff > 5) {
            // Small movement
            calibratedDistance = distance * 0.9;
        } else {
            // Very small movement, use screen-space estimation
            const screenDx = p2.screenX - p1.screenX;
            const screenDy = p2.screenY - p1.screenY;
            const pixelDistance = Math.sqrt(screenDx * screenDx + screenDy * screenDy);
            calibratedDistance = (pixelDistance / 150) * virtualDepth;
        }

        // Clamp to reasonable values (0.1m to 20m)
        return Math.max(0.1, Math.min(calibratedDistance, 20));
    }

    // Draw point on canvas
    function drawPoint(x, y, number) {
        const marker = document.createElement('div');
        marker.className = 'point-marker';
        marker.style.left = (x / canvas.width * 100) + '%';
        marker.style.top = (y / canvas.height * 100) + '%';
        marker.textContent = number;
        marker.style.display = 'flex';
        marker.style.alignItems = 'center';
        marker.style.justifyContent = 'center';
        marker.style.fontSize = '12px';
        marker.style.fontWeight = 'bold';
        document.querySelector('.camera-container').appendChild(marker);
    }

    // Draw line between points
    function drawLine(p1, p2, distance) {
        const line = document.createElement('div');
        line.className = 'line';
        
        const x1 = (p1.x / canvas.width * 100);
        const y1 = (p1.y / canvas.height * 100);
        const x2 = (p2.x / canvas.width * 100);
        const y2 = (p2.y / canvas.height * 100);
        
        const length = Math.sqrt(Math.pow(x2 - x1, 2) + Math.pow(y2 - y1, 2));
        const angle = Math.atan2(y2 - y1, x2 - x1) * 180 / Math.PI;
        
        line.style.left = x1 + '%';
        line.style.top = y1 + '%';
        line.style.width = length + '%';
        line.style.transform = `rotate(${angle}deg)`;
        
        document.querySelector('.camera-container').appendChild(line);

        // Add distance label
        const label = document.createElement('div');
        label.className = 'distance-label';
        label.textContent = `${distance.toFixed(2)} m`;
        label.style.left = ((x1 + x2) / 2) + '%';
        label.style.top = ((y1 + y2) / 2) + '%';
        document.querySelector('.camera-container').appendChild(label);
    }

    // Update measurements list
    function updateMeasurementsList() {
        const content = document.getElementById('measurementsContent');
        content.innerHTML = '';
        
        measurements.forEach((m, index) => {
            const item = document.createElement('div');
            item.className = 'measurement-item';
            item.innerHTML = `
                <span>Pengukuran ${index + 1}</span>
                <strong>${m.distance.toFixed(2)} meter</strong>
            `;
            content.appendChild(item);
        });

        document.getElementById('measurementsList').classList.remove('hidden');
    }

    // Auto-fill inputs from measurements
    function autoFillInputs(distance) {
        if (!document.getElementById('panjang').value) {
            document.getElementById('panjang').value = distance.toFixed(2);
        } else if (!document.getElementById('lebar').value) {
            document.getElementById('lebar').value = distance.toFixed(2);
        } else if (!document.getElementById('tinggi').value) {
            document.getElementById('tinggi').value = distance.toFixed(2);
        }
    }

    // Reset
    document.getElementById('reset').addEventListener('click', () => {
        points = [];
        measurements = [];
        document.querySelectorAll('.point-marker, .line, .distance-label').forEach(el => el.remove());
        document.getElementById('measurementsList').classList.add('hidden');
        statusText.textContent = cameraActive ? 'üìç Tandai titik pertama' : 'Klik tombol "Buka Kamera AR" untuk memulai';
    });

    // Calculate materials
    document.getElementById('calculate').addEventListener('click', () => {
        const panjang = parseFloat(document.getElementById('panjang').value) || 0;
        const lebar = parseFloat(document.getElementById('lebar').value) || 0;
        const tinggi = parseFloat(document.getElementById('tinggi').value) || 0;

        if (panjang === 0 || lebar === 0) {
            alert('Masukkan minimal panjang dan lebar!');
            return;
        }

        const luas = panjang * lebar;
        const volume = tinggi > 0 ? panjang * lebar * tinggi : 0;
        
        const hebel = Math.ceil(luas * 8);
        const semen = volume > 0 ? Math.ceil(volume * 5.5) : Math.ceil(luas * 0.02 * 5.5);
        const pasir = (luas * 0.5).toFixed(2);
        const acian = Math.ceil(luas / 3.5);

        document.getElementById('luas').textContent = `${luas.toFixed(2)} m¬≤`;
        document.getElementById('volume').textContent = volume > 0 ? `${volume.toFixed(2)} m¬≥` : '-';
        document.getElementById('hebel').textContent = `${hebel} buah`;
        document.getElementById('semen').textContent = `${semen} zak`;
        document.getElementById('pasir').textContent = `${pasir} m¬≥`;
        document.getElementById('acian').textContent = `${acian} zak`;

        document.getElementById('results').classList.remove('hidden');
        document.getElementById('results').scrollIntoView({ behavior: 'smooth' });
    });

    // Cleanup
    window.addEventListener('beforeunload', () => {
        if (stream) {
            stream.getTracks().forEach(track => track.stop());
        }
    });
</script>


</body>
</html>
